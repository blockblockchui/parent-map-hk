<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯è¦ªå­åœ°åœ– | Parent Map HK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="js/image-loader.js" defer></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        #map { height: 300px; width: 100%; }
        @media (min-width: 768px) {
            #map { height: 400px; }
        }
        .leaflet-popup-content { font-family: 'Noto Sans TC', sans-serif; }
        
        /* Masonry Layout Support */
        .break-inside-avoid {
            break-inside: avoid;
            page-break-inside: avoid;
            -webkit-column-break-inside: avoid;
        }
        
        /* Better spacing for masonry */
        .columns-1, .columns-2, .columns-3 {
            column-gap: 1.5rem;
        }
        
        /* Space-y doesn't work well with columns, use margin-bottom on cards instead */
        .columns-1 > *, .columns-2 > *, .columns-3 > * {
            margin-bottom: 1.5rem;
        }
        
        /* List View Layout */
        .list-view {
            columns: 1 !important;
        }
        
        .list-view .location-card {
            display: flex !important;
            flex-direction: row !important;
            align-items: stretch;
            margin-bottom: 0.75rem;
        }
        
        .list-view .card-image-wrapper {
            width: 120px;
            min-width: 120px;
            height: 100px;
            flex-shrink: 0;
        }
        
        .list-view .card-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem 0 0 0.5rem;
        }
        
        .list-view .card-content {
            flex: 1;
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .list-view .card-main {
            flex: 1;
        }
        
        .list-view .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            padding-left: 0.5rem;
        }
        
        .list-view .card-title {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .list-view .card-meta {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .list-view .card-tags {
            margin-bottom: 0.25rem;
        }
        
        .list-view .card-desc {
            display: none;
        }
        
        @media (max-width: 640px) {
            .list-view .location-card {
                flex-direction: row;
            }
            
            .list-view .card-image-wrapper {
                width: 100px;
                min-width: 100px;
                height: 90px;
            }
            
            .list-view .card-actions {
                flex-direction: column;
                padding-left: 0.5rem;
            }
            
            .list-view .card-actions a {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
        <div class="max-w-7xl mx-auto px-4 py-6 md:py-12">
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-2">ğŸ—ºï¸ é¦™æ¸¯è¦ªå­åœ°åœ–</h1>
                <p class="text-base sm:text-lg md:text-xl text-blue-100 mb-6">ç™¼æ˜å…¨æ¸¯æœ€é©åˆè¦ªå­æ´»å‹•çš„å¥½å»è™•</p>
                
                <!-- å¿«é€Ÿæœå°‹ -->
                <div class="max-w-2xl mx-auto flex gap-2 px-4 sm:px-0">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹åœ°é»..." 
                           class="flex-1 min-w-0 px-4 py-3 rounded-lg text-gray-900 text-base focus:outline-none focus:ring-4 focus:ring-blue-300">
                    <button id="searchBtn" class="px-4 sm:px-6 py-3 bg-yellow-400 text-gray-900 font-bold rounded-lg hover:bg-yellow-300 transition-colors whitespace-nowrap">
                        æœå°‹
                    </button>
                </div>
                
                <!-- ğŸ¯ æ¨è–¦å ´æ™¯å…¥å£ -->
                <div class="mt-6 flex flex-wrap justify-center gap-2 px-2">
                    <button class="scenario-btn px-4 py-2 bg-white/90 text-blue-700 rounded-full text-sm font-medium hover:bg-white transition-colors shadow-sm" data-scenario="rainy">
                        ğŸŒ§ï¸ å””æ€•è½é›¨
                    </button>
                    <button class="scenario-btn px-4 py-2 bg-white/90 text-blue-700 rounded-full text-sm font-medium hover:bg-white transition-colors shadow-sm" data-scenario="baby">
                        ğŸ§’ 2æ­²ä»¥ä¸‹
                    </button>
                    <button class="scenario-btn px-4 py-2 bg-white/90 text-blue-700 rounded-full text-sm font-medium hover:bg-white transition-colors shadow-sm" data-scenario="birthday">
                        ğŸ‚ ç”Ÿæ—¥æœƒå ´åœ°
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-wrap gap-3">
                <!-- åœ°å€ç¯©é¸ï¼ˆé¦™æ¸¯åå…«å€ï¼‰ -->
                <select id="regionFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™åœ°å€</option>
                    <optgroup label="æ¸¯å³¶">
                        <option value="ä¸­è¥¿å€">ä¸­è¥¿å€</option>
                        <option value="ç£ä»”">ç£ä»”</option>
                        <option value="æ±å€">æ±å€</option>
                        <option value="å—å€">å—å€</option>
                    </optgroup>
                    <optgroup label="ä¹é¾">
                        <option value="æ²¹å°–æ—º">æ²¹å°–æ—º</option>
                        <option value="æ·±æ°´åŸ—">æ·±æ°´åŸ—</option>
                        <option value="ä¹é¾åŸ">ä¹é¾åŸ</option>
                        <option value="é»ƒå¤§ä»™">é»ƒå¤§ä»™</option>
                        <option value="è§€å¡˜">è§€å¡˜</option>
                    </optgroup>
                    <optgroup label="æ–°ç•Œ">
                        <option value="èƒç£">èƒç£</option>
                        <option value="å±¯é–€">å±¯é–€</option>
                        <option value="å…ƒæœ—">å…ƒæœ—</option>
                        <option value="åŒ—å€">åŒ—å€</option>
                        <option value="å¤§åŸ”">å¤§åŸ”</option>
                        <option value="æ²™ç”°">æ²™ç”°</option>
                        <option value="è¥¿è²¢">è¥¿è²¢</option>
                        <option value="é›¢å³¶">é›¢å³¶</option>
                        <option value="è‘µé’">è‘µé’</option>
                    </optgroup>
                </select>

                <!-- é¡åˆ¥ç¯©é¸ -->
                <select id="categoryFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™é¡å‹</option>
                    <option value="playhouse">ğŸª éŠæ¨‚å ´</option>
                    <option value="park">ğŸŒ³ å…¬åœ’</option>
                    <option value="museum">ğŸ›ï¸ åšç‰©é¤¨/å±•è¦½</option>
                </select>

                <!-- äººå‡æ¶ˆè²» -->
                <select id="priceFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™æ¶ˆè²»</option>
                    <option value="free">å…è²»</option>
                    <option value="1-100">$1-100</option>
                    <option value="100-200">$100-200</option>
                    <option value="200-400">$200-400</option>
                    <option value="400+">$400+</option>
                </select>

                <!-- é©åˆå¹´é½¡ -->
                <select id="ageFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™å¹´é½¡</option>
                    <option value="0-1">0-1æ­²</option>
                    <option value="1-2">1-2æ­²</option>
                    <option value="2-3">2-3æ­²</option>
                    <option value="3-6">3-6æ­²</option>
                    <option value="6-12">6-12æ­²</option>
                    <option value="12+">12æ­²+</option>
                </select>

                <!-- å®¤å…§/å®¤å¤– -->
                <select id="indoorFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™å®¤å…§å®¤å¤–</option>
                    <option value="indoor">ğŸ  å®¤å…§</option>
                    <option value="outdoor">â˜€ï¸ å®¤å¤–</option>
                </select>

                <!-- è·é›¢ç¯©é¸ï¼ˆéœ€è¦å®šä½ï¼‰ -->
                <select id="distanceFilter" class="px-3 py-2 border rounded-lg text-sm">
                    <option value="all">ä¸é™è·é›¢</option>
                    <option value="400">ğŸ“ 400ç±³å…§</option>
                    <option value="800">ğŸ“ 800ç±³å…§</option>
                    <option value="1000">ğŸ“ 1å…¬é‡Œå…§</option>
                    <option value="2000">ğŸ“ 2å…¬é‡Œå…§</option>
                    <option value="5000">ğŸ“ 5å…¬é‡Œå…§</option>
                </select>

                <!-- æ”¶è—åœ°é» -->
                <button id="favoritesFilter" class="px-3 py-2 bg-gray-100 text-gray-400 border border-gray-200 rounded-lg text-sm hover:bg-gray-200 transition-colors disabled:opacity-50">
                    â¤ï¸ æ”¶è—åœ°é» (<span id="favCount">0</span>)
                </button>
                
                <!-- æ¸…ç©ºæ”¶è— -->
                <button id="clearFavoritesBtn" class="px-3 py-2 bg-gray-100 text-gray-400 border border-gray-200 rounded-lg text-sm hover:bg-red-100 hover:text-red-600 hover:border-red-200 transition-colors disabled:opacity-50 disabled:hover:bg-gray-100 disabled:hover:text-gray-400" disabled>
                    ğŸ—‘ï¸ æ¸…ç©ºæ”¶è—
                </button>
            </div>
        </div>
    </div>

    <!-- Map Toggle Button (Mobile Only) -->
    <div class="md:hidden bg-white border-b px-4 py-2">
        <button id="mapToggleBtn" class="w-full flex items-center justify-center gap-2 py-2 bg-blue-50 text-blue-700 rounded-lg font-medium">
            <span id="mapToggleIcon">ğŸ—ºï¸</span>
            <span id="mapToggleText">éš±è—åœ°åœ–</span>
            <svg id="mapToggleArrow" class="w-4 h-4 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
    </div>

    <!-- Map with Locate Button -->
    <div id="mapContainer" class="relative md:block">
        <div id="map"></div>
        <button id="locateBtn" class="absolute bottom-4 right-4 z-[500] bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 transition-colors" title="å®šä½æˆ‘çš„ä½ç½®">
            ğŸ“ å®šä½æˆ‘
        </button>
    </div>

    <!-- Results -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Sticky Header -->
        <div id="listHeader" class="sticky top-0 z-40 bg-gray-50/95 backdrop-blur-sm py-3 -mx-4 px-4 border-b border-gray-200/50 transition-shadow">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-3 flex-wrap">
                    <span id="resultCount" class="text-sm text-gray-500">è¼‰å…¥ä¸­...</span>
                    <!-- Active scenario buttons will appear here -->
                    <div id="activeScenarios" class="flex items-center gap-1"></div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- æ’åºæ–¹å¼ -->
                    <select id="sortFilter" class="px-3 py-2 border rounded-lg text-sm bg-blue-50 border-blue-200">
                        <option value="updated">ğŸ“… æŒ‰æ›´æ–°æ—¥æœŸ</option>
                        <option value="default">ğŸ“ è·é›¢è¿‘â†’é </option>
                        <option value="price-asc">ğŸ’° åƒ¹æ ¼ä½â†’é«˜</option>
                        <option value="price-desc">ğŸ’° åƒ¹æ ¼é«˜â†’ä½</option>
                    </select>
                    <!-- ä½ˆå±€åˆ‡æ› -->
                    <button id="layoutToggle" class="px-3 py-2 border rounded-lg text-sm bg-white border-gray-300 hover:bg-gray-50 transition-colors" title="åˆ‡æ›ä½ˆå±€">
                        âŠ æ ¼ç‹€
                    </button>
                </div>
            </div>
        </div>
        
        <div id="locationList" class="columns-1 md:columns-2 lg:columns-4 gap-6 space-y-6 pt-4">
            <!-- Locations will be inserted here -->
        </div>
    </div>

    <script>
        // Location data - fetched from JSON
        let locations = [];
        let isLoading = true;
        
        // Fetch locations from JSON
        async function loadLocations() {
            try {
                const response = await fetch('data/locations.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                locations = data.locations || [];
                isLoading = false;
                
                // Update UI
                document.getElementById('resultCount').textContent = `å·²åŠ è¼‰ ${locations.length} å€‹åœ°é»`;
                
                // Set default filters and render
                setDefaultFilters();
                renderLocations();
                
                console.log(`âœ… Loaded ${locations.length} locations from JSON`);
            } catch (error) {
                console.error('âŒ Error loading locations:', error);
                document.getElementById('resultCount').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢';
                document.getElementById('locationList').innerHTML = `
                    <div class="text-center py-8 text-red-600 w-full">
                        <p>âš ï¸ ç„¡æ³•è¼‰å…¥åœ°é»è³‡æ–™</p>
                        <p class="text-sm mt-2">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
            }
        }
        
        const categoryLabels = {
            museum: 'åšç‰©é¤¨',
            park: 'å…¬åœ’',
            playhouse: 'éŠæ¨‚å ´',
            restaurant: 'é¤å»³',
            library: 'åœ–æ›¸é¤¨'
        };

        const regionLabels = {
            'hk-island': 'æ¸¯å³¶',
            'kowloon': 'ä¹é¾',
            'nt': 'æ–°ç•Œ'
        };

        const priceLabels = {
            free: 'å…è²»',
            low: 'ä½æ¶ˆè²»',
            medium: 'ä¸­æ¶ˆè²»',
            high: 'é«˜æ¶ˆè²»'
        };

        // Initialize Leaflet map FIRST
        const map = L.map('map').setView([22.32, 114.17], 11);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Force map to recalculate size after initialization
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        // Start loading locations AFTER map is ready
        loadLocations();
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Filter state
        let markers = [];

        // Favorites state
        let favorites = JSON.parse(localStorage.getItem('parentMapFavorites') || '[]');
        let showFavoritesOnly = false;
        
        // Layout state (grid or list) - default: grid on desktop, list on mobile
        const isMobile = window.innerWidth < 768;
        let isListView = localStorage.getItem('parentMapLayout') ? 
            localStorage.getItem('parentMapLayout') === 'list' : 
            isMobile;

        // Update favorites count and button style
        function updateFavoritesUI() {
            const favCount = favorites.length;
            document.getElementById('favCount').textContent = favCount;
            const favBtn = document.getElementById('favoritesFilter');
            const clearBtn = document.getElementById('clearFavoritesBtn');
            
            if (favCount > 0) {
                // æœ‰æ”¶è—ï¼šè®Šæˆç´…è‰²å¯ç”¨ç‹€æ…‹
                favBtn.classList.remove('bg-gray-100', 'text-gray-400', 'border-gray-200');
                favBtn.classList.add('bg-red-50', 'text-red-600', 'border-red-200', 'hover:bg-red-100');
                favBtn.disabled = false;
                // å•Ÿç”¨æ¸…ç©ºæŒ‰éˆ•
                clearBtn.disabled = false;
                clearBtn.classList.remove('bg-gray-100', 'text-gray-400');
                clearBtn.classList.add('bg-gray-50', 'text-gray-600');
            } else {
                // ç„¡æ”¶è—ï¼šgreyed out
                favBtn.classList.remove('bg-red-50', 'text-red-600', 'border-red-200', 'hover:bg-red-100');
                favBtn.classList.add('bg-gray-100', 'text-gray-400', 'border-gray-200');
                favBtn.disabled = true;
                showFavoritesOnly = false;
                // ç¦ç”¨æ¸…ç©ºæŒ‰éˆ•
                clearBtn.disabled = true;
                clearBtn.classList.remove('bg-gray-50', 'text-gray-600');
                clearBtn.classList.add('bg-gray-100', 'text-gray-400');
            }
        }

        // Clear all favorites with confirmation
        function clearAllFavorites() {
            if (favorites.length === 0) return;
            
            const confirmed = confirm(`ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ ${favorites.length} å€‹æ”¶è—å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`);
            if (confirmed) {
                favorites = [];
                localStorage.setItem('parentMapFavorites', JSON.stringify(favorites));
                showFavoritesOnly = false;
                updateFavoritesUI();
                renderLocations();
                alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰æ”¶è—');
            }
        }

        // Toggle favorite
        function toggleFavorite(locationId) {
            const index = favorites.indexOf(locationId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(locationId);
            }
            localStorage.setItem('parentMapFavorites', JSON.stringify(favorites));
            updateFavoritesUI();
            renderLocations();
        }

        // Check if location is favorite
        function isFavorite(locationId) {
            return favorites.includes(locationId);
        }

        // User location storage
        let userLocation = null;

        // Haversine formula to calculate distance
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lng2 - lng1) * Math.PI / 180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c; // Distance in meters
        }

        // æª¢æŸ¥é–‹æ”¾æ—¥æ˜¯å¦åŒ¹é…
        function checkOpenDay(openingHours, selectedDay) {
            if (selectedDay === 'all') return true;
            if (!openingHours) return true;
            
            const hours = openingHours.toLowerCase();
            const dayMap = {
                'mon': ['å‘¨ä¸€', 'æ˜ŸæœŸä¸€', 'mon'],
                'tue': ['å‘¨äºŒ', 'æ˜ŸæœŸäºŒ', 'tue'],
                'wed': ['å‘¨ä¸‰', 'æ˜ŸæœŸä¸‰', 'wed'],
                'thu': ['å‘¨å››', 'æ˜ŸæœŸå››', 'thu'],
                'fri': ['å‘¨äº”', 'æ˜ŸæœŸäº”', 'fri'],
                'sat': ['å‘¨å…­', 'æ˜ŸæœŸå…­', 'sat'],
                'sun': ['å‘¨æ—¥', 'æ˜ŸæœŸæ—¥', 'sun']
            };
            
            const dayNames = dayMap[selectedDay];
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¼‘æ¯æ—¥æ¨™è¨˜
            for (const name of dayNames) {
                if (hours.includes(name + 'ä¼‘') || hours.includes(name + 'ä¼‘æ¯')) {
                    return false; // å‘¢æ—¥ä¼‘æ¯
                }
            }
            
            // å¦‚æœå¯«æ˜ã€Œå…¨æ—¥ã€æˆ–ã€Œæ¯å¤©ã€ï¼Œè¡¨ç¤ºé–‹æ”¾
            if (hours.includes('å…¨æ—¥') || hours.includes('æ¯å¤©') || hours.includes('24å°æ™‚')) {
                return true;
            }
            
            // é»˜èªé–‹æ”¾ï¼ˆå¦‚æœç„¡ç‰¹åˆ¥æ¨™è¨˜ä¼‘æ¯ï¼‰
            return true;
        }

        // ç²å–åƒ¹æ ¼æ•¸å€¼ï¼ˆç”¨æ–¼æ’åºï¼‰
        function getPriceValue(priceType) {
            const priceValues = {
                'free': 0,
                'low': 1,
                'medium': 2,
                'high': 3
            };
            return priceValues[priceType] || 2;
        }

        // ç²å–åƒ¹æ ¼ç¬¦è™Ÿï¼ˆ$ / $$ / $$$ï¼‰
        function getPriceSymbol(priceType) {
            const symbols = {
                'free': 'ğŸ†“ å…è²»',
                'low': '$',
                'medium': '$$',
                'high': '$$$'
            };
            return symbols[priceType] || '$$';
        }

        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatLastUpdated(date) {
            if (!date) return '';
            const d = new Date(date);
            const now = new Date();
            const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'ä»Šæ—¥æ›´æ–°';
            if (diffDays === 1) return 'æ˜¨æ—¥æ›´æ–°';
            if (diffDays < 7) return `${diffDays}æ—¥å‰æ›´æ–°`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}æ˜ŸæœŸå‰æ›´æ–°`;
            return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥æ›´æ–°`;
        }

        // æª¢æŸ¥é–‹æ”¾æ™‚é–“æ˜¯å¦åŒ¹é…
        function checkOpenTime(openingHours, selectedTime) {
            if (selectedTime === 'all') return true;
            if (!openingHours) return true;
            
            const hours = openingHours.toLowerCase();
            
            // æå–æ™‚é–“ç¯„åœï¼ˆç°¡åŒ–è™•ç†ï¼‰
            const timeMatch = hours.match(/(\d{1,2}):?(\d{2})?\s*[\-â€“~]\s*(\d{1,2}):?(\d{2})?/);
            if (!timeMatch) return true; // ç„¡æ³•è§£æï¼Œé»˜èªé–‹æ”¾
            
            const openHour = parseInt(timeMatch[1]);
            const closeHour = parseInt(timeMatch[3]);
            
            // æ™‚é–“æ®µå®šç¾©
            const timeRanges = {
                'morning': { start: 8, end: 12 },    // 08:00-12:00
                'afternoon': { start: 12, end: 18 }, // 12:00-18:00
                'evening': { start: 18, end: 22 }    // 18:00-22:00
            };
            
            const selectedRange = timeRanges[selectedTime];
            if (!selectedRange) return true;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Š
            return (openHour < selectedRange.end && closeHour > selectedRange.start);
        }

        function renderLocations() {
            const region = document.getElementById('regionFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const age = document.getElementById('ageFilter').value;
            const price = document.getElementById('priceFilter').value;
            const indoor = document.getElementById('indoorFilter').value;
            const distance = document.getElementById('distanceFilter').value;

            let filtered = locations.filter(l => {
                // åœ°å€ç¯©é¸ï¼ˆåå…«å€ï¼‰
                if (region !== 'all' && !l.district.includes(region)) return false;
                
                // é¡åˆ¥ç¯©é¸
                if (category !== 'all' && l.category !== category) return false;
                
                // å¹´é½¡ç¯©é¸ï¼ˆ0-1, 1-2, 2-3, 3-6, 6-12, 12+ï¼‰
                if (age !== 'all') {
                    const [minAge, maxAge] = age.split('-').map(a => a === '12+' ? 12 : parseInt(a));
                    if (maxAge) {
                        // ç¯„åœæª¢æŸ¥ï¼ˆä¾‹å¦‚ 3-6ï¼‰
                        if (l.ageRange[1] < minAge || l.ageRange[0] > maxAge) return false;
                    } else {
                        // 12+ æª¢æŸ¥
                        if (l.ageRange[1] < 12) return false;
                    }
                }
                
                // æ¶ˆè²»ç¯©é¸
                if (price !== 'all') {
                    if (price === 'free') {
                        if (l.priceType !== 'free') return false;
                    } else {
                        const priceMap = {
                            '1-100': ['low'],
                            '100-200': ['medium'],
                            '200-400': ['high'],
                            '400+': ['high']
                        };
                        if (!priceMap[price].includes(l.priceType)) return false;
                    }
                }
                
                // å®¤å…§/å®¤å¤–ç¯©é¸
                if (indoor === 'indoor' && !l.indoor) return false;
                if (indoor === 'outdoor' && l.indoor) return false;
                
                // æˆ‘çš„æ”¶è—ç¯©é¸
                if (showFavoritesOnly && !favorites.includes(l.id)) return false;
                
                return true;
            });
            
            // è·é›¢ç¯©é¸ï¼ˆéœ€è¦ç”¨æˆ¶å·²å®šä½ï¼‰
            if (distance !== 'all') {
                if (!userLocation) {
                    // æç¤ºç”¨æˆ¶éœ€è¦å…ˆå®šä½
                    alert('ğŸ“ è«‹å…ˆé»æ“Šã€Œå®šä½æˆ‘ã€æŒ‰éˆ•ï¼Œå†ä½¿ç”¨è·é›¢ç¯©é¸åŠŸèƒ½');
                    document.getElementById('distanceFilter').value = 'all';
                } else {
                    const maxDistance = parseInt(distance);
                    filtered = filtered.filter(l => {
                        const dist = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            l.lat, l.lng
                        );
                        return dist <= maxDistance;
                    });
                }
            }

            // ğŸ¯ æ’åºåŠŸèƒ½
            const sortValue = document.getElementById('sortFilter').value;
            switch(sortValue) {
                case 'updated':
                    // æœ€è¿‘æ›´æ–°ï¼ˆå‡è¨­æœ‰ updatedAt æ¬„ä½ï¼Œå†‡å°±ç”¨ id å€’åºï¼‰
                    filtered.sort((a, b) => (b.updatedAt || b.id) - (a.updatedAt || a.id));
                    break;
                case 'price-asc':
                    filtered.sort((a, b) => getPriceValue(a.priceType) - getPriceValue(b.priceType));
                    break;
                case 'price-desc':
                    filtered.sort((a, b) => getPriceValue(b.priceType) - getPriceValue(a.priceType));
                    break;
                default:
                    // è·é›¢æœ€è¿‘ï¼šæœ‰å®šä½å°±æŒ‰è·é›¢æ’åº
                    if (userLocation) {
                        filtered.sort((a, b) => {
                            const distA = calculateDistance(userLocation.lat, userLocation.lng, a.lat, a.lng);
                            const distB = calculateDistance(userLocation.lat, userLocation.lng, b.lat, b.lng);
                            return distA - distB;
                        });
                    }
                    break;
            }

            // Update list
            const listEl = document.getElementById('locationList');
            const countEl = document.getElementById('resultCount');
            
            // é¡¯ç¤ºçµæœæ•¸é‡
            let countText = '';
            
            if (showFavoritesOnly) {
                countText = `æ”¶è—åœ°é»: ${filtered.length} å€‹å¥½å»è™•`;
            } else if (filtered.length === 0) {
                countText = `æš«æ™‚æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ°é»`;
            } else {
                countText = `æ‰¾åˆ° ${filtered.length} å€‹å¥½å»è™•`;
            }
            countEl.textContent = countText;
            countEl.className = 'text-sm text-gray-600 font-medium';
            
            // Category icons and colors
            const categoryIcons = {
                museum: { icon: 'ğŸ›ï¸', bg: 'from-amber-400 to-orange-500' },
                park: { icon: 'ğŸŒ³', bg: 'from-green-400 to-emerald-500' },
                playhouse: { icon: 'ğŸª', bg: 'from-blue-400 to-indigo-500' },
                restaurant: { icon: 'ğŸ½ï¸', bg: 'from-rose-400 to-pink-500' },
                library: { icon: 'ğŸ“š', bg: 'from-violet-400 to-purple-500' }
            };
            
            // Render cards based on layout mode
            listEl.innerHTML = filtered.map(l => {
                // è¨ˆç®—è·é›¢ï¼ˆå¦‚æœç”¨æˆ¶å·²å®šä½ï¼Œä¸€å¾‹é¡¯ç¤ºï¼‰
                let distanceHtml = '';
                if (userLocation) {
                    const dist = calculateDistance(userLocation.lat, userLocation.lng, l.lat, l.lng);
                    const distText = dist >= 1000 ? `${(dist/1000).toFixed(1)}å…¬é‡Œ` : `${Math.round(dist)}ç±³`;
                    
                    // è¨ˆç®—æ­¥è¡Œæ™‚é–“ (1å…¬é‡Œ = 12åˆ†é˜)
                    const walkingMinutes = Math.round((dist / 1000) * 12);
                    if (walkingMinutes <= 30) {
                        distanceHtml = `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${distText} ğŸš¶ç´„${walkingMinutes}åˆ†é˜</span>`;
                    } else {
                        distanceHtml = `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">${distText} ğŸš¶é å·¦å•²</span>`;
                    }
                }
                
                const catStyle = categoryIcons[l.category] || { icon: 'ğŸ¯', bg: 'from-blue-400 to-purple-500' };
                
                // Check if place has local image
                const hasImage = l.images?.local || l.images?.cloudinary;
                const imageUrl = l.images?.local || l.images?.cloudinary;
                
                // Common elements
                const tagsHtml = `
                    <div class="flex flex-wrap gap-2 mb-3${isListView ? ' card-tags' : ''}">
                        ${l.indoor ? '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">å®¤å…§</span>' : '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">æˆ¶å¤–</span>'}
                        ${l.hasBabyRoom ? '<span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded">ğŸ‘¶å“ºä¹³å®¤</span>' : ''}
                        ${l.hasRestaurant ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ğŸ´æœ‰é¤å»³</span>' : ''}
                    </div>
                `;
                
                const agePriceHtml = `
                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                        <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">${l.ageRange[0]}-${l.ageRange[1]}æ­²</span>
                        <span class="text-xs font-medium ${l.priceType === 'free' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} px-2 py-1 rounded">${getPriceSymbol(l.priceType)}</span>
                    </div>
                `;
                
                // Determine website URL (priority: website > facebook > instagram)
                const websiteUrl = l.website || l.facebook_url || l.instagram_url;
                const websiteLabel = l.website ? 'ğŸŒ ç¶²ç«™' : (l.facebook_url ? 'ğŸ“˜ Facebook' : 'ğŸ“· Instagram');
                
                const actionsHtml = `
                    ${l.phone ? `<a href="tel:${l.phone}" class="py-2 text-sm text-gray-700 bg-gray-100 rounded text-center hover:bg-gray-200 transition-colors">ğŸ“ é›»è©±</a>` : ''}
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${l.lat},${l.lng}" target="_blank" rel="noopener noreferrer" class="py-2 text-sm text-green-700 bg-green-50 rounded text-center hover:bg-green-100 transition-colors">ğŸ—ºï¸ è·¯ç·š</a>
                    ${websiteUrl ? `<a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="py-2 text-sm text-blue-700 bg-blue-50 rounded text-center hover:bg-blue-100 transition-colors">${websiteLabel}</a>` : ''}
                `;
                
                if (isListView) {
                    // List view layout - mobile hides images, shows on sm and up
                    const imageSection = hasImage ? `
                        <div class="card-image-wrapper hidden sm:block">
                            <img src="${imageUrl}" alt="${l.name}"
                                class="w-full h-full object-cover"
                                onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'bg-gradient-to-br ${catStyle.bg} w-full h-full flex items-center justify-center\\'><span class=\\'text-white text-3xl\\'>${catStyle.icon}</span></div>';">
                        </div>
                    ` : `
                        <div class="card-image-wrapper bg-gradient-to-br ${catStyle.bg} hidden sm:flex items-center justify-center">
                            <span class="text-white text-3xl">${catStyle.icon}</span>
                        </div>
                    `;

                    return `
                    <div class="location-card bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300">
                        ${imageSection}
                        <div class="card-content">
                            <div class="card-main">
                                <!-- ç¬¬ä¸€è¡Œï¼šé¡å‹ + åç¨± -->
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">${categoryLabels[l.category]}</span>
                                    <h3 class="card-title font-bold text-gray-900">${l.name}</h3>
                                </div>
                                <!-- ç¬¬äºŒè¡Œï¼šåœ°å€ + å®¤å…§/å®¤å¤– -->
                                <div class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${l.district}</span>
                                    <span class="text-xs">${l.indoor ? 'ğŸ  å®¤å…§' : 'ğŸŒ³ æˆ¶å¤–'}</span>
                                    ${distanceHtml}
                                </div>
                                <!-- ç¬¬ä¸‰è¡Œï¼šå¹´é½¡ + åƒ¹æ ¼ -->
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">${l.ageRange[0]}-${l.ageRange[1]}æ­²</span>
                                    <span class="text-xs font-medium ${l.priceType === 'free' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} px-2 py-1 rounded">${getPriceSymbol(l.priceType)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            ${actionsHtml}
                            <button onclick="toggleFavorite('${l.id}')" class="text-2xl hover:scale-110 transition-transform px-2" title="${isFavorite(l.id) ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥æ”¶è—'}">
                                ${isFavorite(l.id) ? 'â¤ï¸' : 'ğŸ¤'}
                            </button>
                        </div>
                    </div>
                    `;
                } else {
                    // Grid view layout (original)
                    return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 break-inside-avoid mb-6">
                        ${hasImage ? `
                        <div class="relative overflow-hidden" style="min-height: 160px;">
                            <img src="${imageUrl}" alt="${l.name}" 
                                class="w-full h-40 object-cover transition-transform duration-300 hover:scale-105"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="bg-gradient-to-br ${catStyle.bg} items-center justify-center relative hidden" style="min-height: 160px; display: none;">
                                <span class="text-white text-5xl drop-shadow-lg py-8">${catStyle.icon}</span>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-3">
                                    <span class="text-white text-sm font-medium">${categoryLabels[l.category]}</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="bg-gradient-to-br ${catStyle.bg} flex items-center justify-center relative" style="min-height: 160px;">
                            <span class="text-white text-5xl drop-shadow-lg py-8">${catStyle.icon}</span>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-3">
                                <span class="text-white text-sm font-medium">${categoryLabels[l.category]}</span>
                            </div>
                        </div>
                        `}
                        <div class="p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex flex-wrap gap-1">
                                    <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">${categoryLabels[l.category]}</span>
                                    ${distanceHtml}
                                </div>
                                <button onclick="toggleFavorite('${l.id}')" class="text-2xl hover:scale-110 transition-transform" title="${isFavorite(l.id) ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥æ”¶è—'}">
                                    ${isFavorite(l.id) ? 'â¤ï¸' : 'ğŸ¤'}
                                </button>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mt-1">${l.name}</h3>
                            ${l.nameEn ? `<p class="text-xs text-gray-500">${l.nameEn}</p>` : ''}
                            
                            <div class="flex items-center gap-1 text-sm text-gray-600 my-2">
                                <span>ğŸ“</span>
                                <span>${l.district}</span>
                            </div>

                            ${tagsHtml}
                            ${agePriceHtml}

                            <p class="text-sm text-gray-600 line-clamp-2 mb-3">${l.description.substring(0, 80)}${l.description.length > 80 ? '...' : ''}</p>

                            <div class="flex items-start gap-2 text-xs text-gray-500 mb-3">
                                <span class="mt-0.5">ğŸ•</span>
                                <span class="whitespace-pre-line">${l.openingHours.replace(/\\n/g, '\n')}</span>
                            </div>

                            <div class="flex gap-2 pt-3 border-t">
                                ${actionsHtml}
                            </div>
                        </div>
                    </div>
                    `;
                }
            }).join('');

            // Update map markers
            // æ¸…é™¤èˆŠ markers
            markers.forEach(m => {
                if (map.hasLayer(m)) {
                    map.removeLayer(m);
                }
            });
            markers = [];

            // å»¶é²æ·»åŠ æ–° markersï¼Œç¢ºä¿åœ°åœ–å·²æº–å‚™å¥½
            requestAnimationFrame(() => {
                filtered.forEach(l => {
                    if (l.lat && l.lng) {
                        const marker = L.marker([parseFloat(l.lat), parseFloat(l.lng)])
                            .addTo(map)
                            .bindPopup(`
                                <div style="font-family: 'Noto Sans TC', sans-serif;">
                                    <b style="font-size: 14px;">${l.name}</b><br>
                                    <span style="color: #666; font-size: 12px;">${categoryLabels[l.category]}</span><br>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${l.lat},${l.lng}" 
                                       target="_blank" 
                                       style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #22c55e; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">
                                       ğŸ—ºï¸ å–å¾—è·¯ç·š
                                    </a>
                                </div>
                            `);
                        markers.push(marker);
                    }
                });

                // Fit map to markers
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                // å¼·åˆ¶åœ°åœ–é‡æ–°æ¸²æŸ“
                setTimeout(() => {
                    map.invalidateSize();
                    map.panBy([1, 0], { animate: false }); // è¼•å¾®ç§»å‹•å¼·åˆ¶åˆ·æ–°
                    map.panBy([-1, 0], { animate: false });
                }, 100);
            });
        }

        // Event listeners for all filters
        const filterIds = ['regionFilter', 'categoryFilter', 'ageFilter', 'priceFilter', 
                          'indoorFilter', 'distanceFilter', 'sortFilter'];
        filterIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', () => {
                    console.log(`Filter changed: ${id}`);
                    renderLocations();
                });
            }
        });
        
        // æœå°‹åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        
        function handleSearch() {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) {
                renderLocations();
                return;
            }
            
            const filtered = locations.filter(l => 
                l.name.toLowerCase().includes(query) ||
                l.district.toLowerCase().includes(query) ||
                l.description.toLowerCase().includes(query) ||
                l.category.toLowerCase().includes(query)
            );
            
            // æ›´æ–°åˆ—è¡¨
            const listEl = document.getElementById('locationList');
            const countEl = document.getElementById('resultCount');
            countEl.textContent = `æœå°‹ã€Œ${query}ã€æ‰¾åˆ° ${filtered.length} å€‹å¥½å»è™•`;
            
            // æ¸²æŸ“æœå°‹çµæœ
            renderSearchResults(filtered);
        }
        
        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });
        
        // æ¸²æŸ“æœå°‹çµæœï¼ˆå¾©ç”¨ renderLocations å˜…é‚è¼¯ï¼‰
        function renderSearchResults(searchResults) {
            const listEl = document.getElementById('locationList');
            
            if (searchResults.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12 text-gray-500 w-full">
                        <span class="text-4xl block mb-4">ğŸ”</span>
                        <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ°é»</p>
                        <p class="text-sm mt-2">è©¦è©¦å…¶ä»–é—œéµå­—</p>
                    </div>
                `;
                return;
            }
            
            // ä½¿ç”¨ç›¸åŒå˜…æ¸²æŸ“é‚è¼¯
            const categoryIcons = {
                museum: { icon: 'ğŸ›ï¸', bg: 'from-amber-400 to-orange-500' },
                park: { icon: 'ğŸŒ³', bg: 'from-green-400 to-emerald-500' },
                playhouse: { icon: 'ğŸª', bg: 'from-blue-400 to-indigo-500' },
                restaurant: { icon: 'ğŸ½ï¸', bg: 'from-rose-400 to-pink-500' },
                library: { icon: 'ğŸ“š', bg: 'from-violet-400 to-purple-500' }
            };
            
            listEl.innerHTML = searchResults.map(l => {
                const catStyle = categoryIcons[l.category] || { icon: 'ğŸ¯', bg: 'from-blue-400 to-purple-500' };
                
                // Check if place has local image
                const hasImage = l.images?.local || l.images?.cloudinary;
                const imageUrl = l.images?.local || l.images?.cloudinary;
                
                return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 break-inside-avoid mb-6">
                    ${hasImage ? `
                    <div class="relative overflow-hidden" style="min-height: 160px;">
                        <img src="${imageUrl}" alt="${l.name}" 
                            class="w-full h-40 object-cover transition-transform duration-300 hover:scale-105"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="bg-gradient-to-br ${catStyle.bg} items-center justify-center relative hidden" style="min-height: 160px; display: none;">
                            <span class="text-white text-5xl drop-shadow-lg py-8">${catStyle.icon}</span>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-3">
                                <span class="text-white text-sm font-medium">${categoryLabels[l.category]}</span>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="bg-gradient-to-br ${catStyle.bg} flex items-center justify-center relative" style="min-height: 160px;">
                        <span class="text-white text-5xl drop-shadow-lg py-8">${catStyle.icon}</span>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-3">
                            <span class="text-white text-sm font-medium">${categoryLabels[l.category]}</span>
                        </div>
                    </div>
                    `}
                    <div class="p-4">
                        <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">
                            ${categoryLabels[l.category]}
                        </span>
                        ${l.verified === false || l.autoDiscovered ? '<span class="text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded ml-1">âš ï¸ æœªé©—è­‰</span>' : ''}
                        <h3 class="text-lg font-bold text-gray-900 mt-1">${l.name}</h3>
                        ${l.nameEn ? `<p class="text-xs text-gray-500">${l.nameEn}</p>` : ''}
                        
                        <div class="flex items-center gap-1 text-sm text-gray-600 my-2">
                            <span>ğŸ“</span>
                            <span>${regionLabels[l.region]} Â· ${l.district}</span>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-3">
                            ${l.indoor ? '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">å®¤å…§</span>' : ''}
                            ${l.rainyDaySuitable ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">â˜‚ï¸é›¨å¤©é©åˆ</span>' : ''}
                            ${l.hasBabyRoom ? '<span class="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded">ğŸ‘¶å“ºä¹³å®¤</span>' : ''}
                            ${l.hasRestaurant ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ğŸ´æœ‰é¤å»³</span>' : ''}
                        </div>

                        <div class="flex items-center justify-between text-sm mb-3">
                            <span class="text-gray-600">é©åˆï¼š${l.ageRange[0]}-${l.ageRange[1]}æ­²</span>
                            <span class="font-medium ${l.priceType === 'free' ? 'text-green-600' : 'text-gray-700'}">${priceLabels[l.priceType]}</span>
                        </div>

                        <p class="text-sm text-gray-600 line-clamp-2 mb-3">${l.description}</p>

                        <div class="flex gap-2 pt-3 border-t">
                            ${l.phone ? `<a href="tel:${l.phone}" class="flex-1 py-2 text-sm text-gray-700 bg-gray-100 rounded text-center hover:bg-gray-200 transition-colors">ğŸ“ é›»è©±</a>` : ''}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${l.lat},${l.lng}" target="_blank" rel="noopener noreferrer" class="flex-1 py-2 text-sm text-green-700 bg-green-50 rounded text-center hover:bg-green-100 transition-colors">ğŸ—ºï¸ è·¯ç·š</a>
                            ${l.website ? `<a href="${l.website}" target="_blank" rel="noopener noreferrer" class="flex-1 py-2 text-sm text-blue-700 bg-blue-50 rounded text-center hover:bg-blue-100 transition-colors">ğŸŒ ç¶²ç«™</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // User location marker
        let userMarker = null;
        let userCircle = null;

        // Geolocation function
        function locateUser() {
            const btn = document.getElementById('locateBtn');
            btn.textContent = 'ğŸ“ å®šä½ä¸­...';
            
            if (!navigator.geolocation) {
                alert('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
                btn.textContent = 'ğŸ“ å®šä½æˆ‘';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Store user location globally
                    userLocation = { lat, lng };

                    // Remove old marker
                    if (userMarker) {
                        map.removeLayer(userMarker);
                        map.removeLayer(userCircle);
                    }

                    // Add user marker
                    userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='background-color:#3b82f6;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);'></div>",
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('ğŸ“ ä½ çš„ä½ç½®').openPopup();

                    // Add accuracy circle
                    userCircle = L.circle([lat, lng], {
                        radius: accuracy,
                        color: '#3b82f6',
                        fillColor: '#3b82f6',
                        fillOpacity: 0.1
                    }).addTo(map);

                    // Center map on user
                    map.setView([lat, lng], 14);

                    // Sort locations by distance and re-render
                    sortLocationsByDistance();
                    renderLocations();

                    btn.textContent = 'ğŸ“ å·²å®šä½';
                    setTimeout(() => {
                        btn.textContent = 'ğŸ“ å®šä½æˆ‘';
                    }, 3000);
                },
                (error) => {
                    let message = 'ç„¡æ³•ç²å–ä½ç½®';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'è«‹å…è¨±ä½¿ç”¨å®šä½åŠŸèƒ½';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'ä½ç½®è³‡è¨Šä¸å¯ç”¨';
                            break;
                        case error.TIMEOUT:
                            message = 'å®šä½è¶…æ™‚ï¼Œè«‹é‡è©¦';
                            break;
                    }
                    alert(message);
                    btn.textContent = 'ğŸ“ å®šä½æˆ‘';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Sort locations by distance from user (for locate button only)
        function sortByDistance(userLat, userLng) {
            const sorted = [...locations].sort((a, b) => {
                const distA = calculateDistance(userLat, userLng, a.lat, a.lng);
                const distB = calculateDistance(userLat, userLng, b.lat, b.lng);
                return distA - distB;
            });
            
            // Update list with distance info
            const currentFilter = document.getElementById('regionFilter').value;
            
            // Only show if not filtering by region
            if (currentFilter === 'all') {
                document.getElementById('resultCount').textContent = `å·²æŒ‰è·é›¢æ’åº - å…± ${sorted.length} å€‹åœ°é»`;
            }
        }

        // Sort locations array by distance from user location
        function sortLocationsByDistance() {
            if (!userLocation) return;
            
            locations.sort((a, b) => {
                const distA = calculateDistance(userLocation.lat, userLocation.lng, a.lat, a.lng);
                const distB = calculateDistance(userLocation.lat, userLocation.lng, b.lat, b.lng);
                return distA - distB;
            });
        }

        // Event listeners for filters
        document.getElementById('regionFilter').addEventListener('change', renderLocations);
        document.getElementById('categoryFilter').addEventListener('change', renderLocations);
        document.getElementById('ageFilter').addEventListener('change', renderLocations);
        document.getElementById('priceFilter').addEventListener('change', renderLocations);
        document.getElementById('indoorFilter').addEventListener('change', renderLocations);
        document.getElementById('sortFilter').addEventListener('change', renderLocations);
        
        // Layout toggle button
        const layoutToggleBtn = document.getElementById('layoutToggle');
        if (layoutToggleBtn) {
            // Set initial state
            updateLayoutButton();
            applyLayoutClass();
            
            layoutToggleBtn.addEventListener('click', function() {
                isListView = !isListView;
                localStorage.setItem('parentMapLayout', isListView ? 'list' : 'grid');
                updateLayoutButton();
                applyLayoutClass();
                renderLocations();
            });
        }
        
        function updateLayoutButton() {
            if (layoutToggleBtn) {
                layoutToggleBtn.innerHTML = isListView ? 'â˜° åˆ—è¡¨' : 'âŠ æ ¼ç‹€';
                layoutToggleBtn.title = isListView ? 'åˆ‡æ›è‡³æ ¼ç‹€ä½ˆå±€' : 'åˆ‡æ›è‡³åˆ—è¡¨ä½ˆå±€';
            }
        }
        
        function applyLayoutClass() {
            const listEl = document.getElementById('locationList');
            if (isListView) {
                listEl.classList.remove('columns-1', 'md:columns-2', 'lg:columns-4', 'gap-6', 'space-y-6');
                listEl.classList.add('list-view', 'space-y-3');
            } else {
                listEl.classList.remove('list-view', 'space-y-3');
                listEl.classList.add('columns-1', 'md:columns-2', 'lg:columns-4', 'gap-6', 'space-y-6');
            }
        }
        
        // Favorites filter button
        const favoritesFilterBtn = document.getElementById('favoritesFilter');
        if (favoritesFilterBtn) {
            favoritesFilterBtn.addEventListener('click', function() {
                // ç„¡æ”¶è—æ™‚å””åŸ·è¡Œ
                if (favorites.length === 0) return;
                
                showFavoritesOnly = !showFavoritesOnly;
                if (showFavoritesOnly) {
                    // å•Ÿç”¨ç¯©é¸ï¼šæ·±è‰²ç´…è‰²
                    this.classList.remove('bg-red-50', 'border-red-200');
                    this.classList.add('bg-red-200', 'border-red-400', 'ring-2', 'ring-red-300');
                } else {
                    // å–æ¶ˆç¯©é¸ï¼šæ·ºè‰²ç´…è‰²
                    this.classList.remove('bg-red-200', 'border-red-400', 'ring-2', 'ring-red-300');
                    this.classList.add('bg-red-50', 'border-red-200');
                }
                renderLocations();
            });
        }
        
        // Clear favorites button
        const clearFavoritesBtn = document.getElementById('clearFavoritesBtn');
        if (clearFavoritesBtn) {
            clearFavoritesBtn.addEventListener('click', function() {
                clearAllFavorites();
            });
        }

        // Locate button event
        document.getElementById('locateBtn').addEventListener('click', locateUser);
        
        // Initialize favorites UI
        updateFavoritesUI();

        // Mobile Map Toggle
        const mapToggleBtn = document.getElementById('mapToggleBtn');
        const mapContainer = document.getElementById('mapContainer');
        const mapToggleText = document.getElementById('mapToggleText');
        const mapToggleArrow = document.getElementById('mapToggleArrow');
        
        if (mapToggleBtn && mapContainer) {
            mapToggleBtn.addEventListener('click', function() {
                const isHidden = mapContainer.classList.contains('hidden');
                
                if (isHidden) {
                    // Show map
                    mapContainer.classList.remove('hidden');
                    mapToggleText.textContent = 'éš±è—åœ°åœ–';
                    mapToggleArrow.classList.add('rotate-180');
                    
                    // Refresh map tiles after showing
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                    
                    // Scroll to map
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // Hide map
                    mapContainer.classList.add('hidden');
                    mapToggleText.textContent = 'é¡¯ç¤ºåœ°åœ–';
                    mapToggleArrow.classList.remove('rotate-180');
                }
            });
        }

        // è¨­ç½®é»˜èªç¯©é¸æ¢ä»¶ï¼ˆå…¨éƒ¨æ¸…ç©ºï¼‰
        function setDefaultFilters() {
            // æ‰€æœ‰ç¯©é¸è¨­ç‚ºé»˜èªå€¼ï¼ˆå…¨éƒ¨ï¼‰
            document.getElementById('regionFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('ageFilter').value = 'all';
            document.getElementById('priceFilter').value = 'all';
            document.getElementById('indoorFilter').value = 'all';
            document.getElementById('distanceFilter').value = 'all';
            document.getElementById('sortFilter').value = 'updated';
        }

        // é¡¯ç¤ºç•¶å‰ç”Ÿæ•ˆçš„å ´æ™¯
        function updateActiveScenario(scenario) {
            const container = document.getElementById('activeScenarios');
            const scenarioLabels = {
                'rainy': 'ğŸŒ§ï¸ å””æ€•è½é›¨',
                'baby': 'ğŸ§’ 2æ­²ä»¥ä¸‹',
                'birthday': 'ğŸ‚ ç”Ÿæ—¥æœƒå ´åœ°'
            };
            
            if (scenario && scenarioLabels[scenario]) {
                container.innerHTML = `
                    <button onclick="clearScenario()" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-200 transition-colors flex items-center gap-1">
                        ${scenarioLabels[scenario]}
                        <span class="text-blue-500">âœ•</span>
                    </button>
                `;
            } else {
                container.innerHTML = '';
            }
        }
        
        // æ¸…é™¤å ´æ™¯ç¯©é¸
        window.clearScenario = function() {
            setDefaultFilters();
            updateActiveScenario(null);
            renderLocations();
        };
        
        // æ¨è–¦å ´æ™¯æŒ‰éˆ•äº‹ä»¶
        document.querySelectorAll('.scenario-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const scenario = this.dataset.scenario;
                
                // é‡ç½®æ‰€æœ‰ç¯©é¸
                document.getElementById('regionFilter').value = 'all';
                document.getElementById('categoryFilter').value = 'all';
                document.getElementById('ageFilter').value = 'all';
                document.getElementById('priceFilter').value = 'all';
                document.getElementById('indoorFilter').value = 'all';
                document.getElementById('distanceFilter').value = 'all';
                
                // æ ¹æ“šå ´æ™¯è¨­ç½®ç¯©é¸
                switch(scenario) {
                    case 'rainy':
                        document.getElementById('indoorFilter').value = 'indoor';
                        break;
                    case 'baby':
                        document.getElementById('ageFilter').value = '0-1'; // 0-1æ­²
                        break;
                    case 'birthday':
                        // ç”Ÿæ—¥æœƒå ´åœ°é€šå¸¸ä¿‚å®¤å…§ + 3-12æ­²
                        document.getElementById('indoorFilter').value = 'indoor';
                        document.getElementById('ageFilter').value = '3-6';
                        break;
                }
                
                // æ›´æ–°æ¨™é¡Œåˆ—é¡¯ç¤º
                updateActiveScenario(scenario);
                
                renderLocations();
            });
        });
        
        // Sticky header shadow effect on scroll
        window.addEventListener('scroll', function() {
            const header = document.getElementById('listHeader');
            if (window.scrollY > 100) {
                header.classList.add('shadow-md');
            } else {
                header.classList.remove('shadow-md');
            }
        });

        // è¨­ç½®é»˜èªç¯©é¸ä¸¦æ¸²æŸ“
        setDefaultFilters();
        
        // Initial render
        renderLocations();
    </script>
</body>
</html>
